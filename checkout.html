<!DOCTYPE html>
<html lang="es">
<head>

<meta charset="UTF-8">
<title>Checkout</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="css/styles.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

</head>

<body>

<div id="navbar-container"></div>


<section class="container my-5">

<div class="row">


<div class="col-md-6">

<form id="form-checkout">

<input class="form-control mb-3" id="nombre" placeholder="Nombre y Apellido" required>

<input class="form-control mb-3" id="direccion" placeholder="Domicilio" required>

<input class="form-control mb-3" id="localidad" placeholder="Localidad" required>

<input class="form-control mb-3" id="telefono" placeholder="TelÃ©fono" required>

<input type="email" class="form-control mb-3" id="email" placeholder="Email" required>

<button type="submit" class="btn btn-success w-100">
Confirmar pedido
</button>

</form>

</div>


<div class="col-md-6">

<h5>Resumen del Pedido</h5>

<div id="resumen-carrito" class="border p-3"></div>

<h5 class="mt-3 text-end">
Total: $<span id="total">0</span>
</h5>

</div>

</div>

</section>


<div id="footer"></div>


<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script src="js/firebase.js"></script>


<script src="js/navbar.js"></script>
<script src="js/footer.js"></script>


<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<script>
emailjs.init("HCatgbCxd_y6A26ta");
</script>


<script>

let carrito = JSON.parse(localStorage.getItem("carrito")) || [];

const resumen = document.getElementById("resumen-carrito");

const totalSpan = document.getElementById("total");

function renderResumen(){

let total = 0;

resumen.innerHTML = "";

if(carrito.length === 0){

resumen.innerHTML = "<p>No hay productos</p>";

return;

}

carrito.forEach(p=>{

const subtotal = p.precio * p.cantidad;

total += subtotal;

resumen.innerHTML += `

<div class="d-flex justify-content-between border-bottom py-2">

<div>
${p.nombre} x${p.cantidad}
</div>

<div>
$${subtotal.toLocaleString()}
</div>

</div>

`;

});

totalSpan.textContent = total.toLocaleString();

}

renderResumen();



function enviarEmailPedido(pedido){

let productosTexto="";

pedido.productos.forEach(p=>{

productosTexto += `${p.nombre} x ${p.cantidad}\n`;

});

emailjs.send(
"service_654s6go",
"template_yea4p95",
{
pedidoId: pedido.id,
nombre: pedido.cliente.nombre,
email: pedido.cliente.email,
telefono: pedido.cliente.telefono,
domicilio: pedido.cliente.direccion,
localidad: pedido.cliente.localidad,
productos: productosTexto,
total: pedido.total,
fecha: new Date().toLocaleString()
});

}



document.getElementById("form-checkout").addEventListener("submit", async e=>{

e.preventDefault();

const user = auth.currentUser;

if(!user){

alert("Debes iniciar sesiÃ³n");

window.location.href="login.html";

return;

}


let total = 0;

carrito.forEach(p=>{

total += p.precio * p.cantidad;

});


const pedido = {

userId:user.uid,

emailUsuario:user.email,

cliente:{
nombre:nombre.value,
direccion:direccion.value,
localidad:localidad.value,
telefono:telefono.value,
email:email.value
},

productos:carrito,

total:total,

fecha:new Date()

};


try{

const docRef = await db.collection("pedidos").add(pedido);

pedido.id = docRef.id;

enviarEmailPedido(pedido);

alert("Pedido confirmado ðŸŽ‰");

localStorage.removeItem("carrito");

window.location.href="index.html";

}catch(error){

alert("Error: "+error.message);

}

});

</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>