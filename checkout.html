<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Checkout</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="css/styles.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

</head>

<body>

<div id="navbar-container"></div>

<section class="container my-5">

<div class="row">

  <!-- FORMULARIO -->
  <div class="col-md-6">

    <form id="form-checkout">

      <input class="form-control mb-3" id="nombre" placeholder="Nombre y Apellido" required>

      <input class="form-control mb-3" id="direccion" placeholder="Domicilio" required>

      <input class="form-control mb-3" id="localidad" placeholder="Localidad" required>

      <input class="form-control mb-3" id="telefono" placeholder="TelÃ©fono" required>

      <input type="email" class="form-control mb-3" id="email" placeholder="Email" required>

      <button type="submit" class="btn btn-success w-100">
        Confirmar pedido
      </button>

    </form>

  </div>

  <!-- RESUMEN -->
  <div class="col-md-6">

    <h5>Resumen del Pedido</h5>

    <div id="resumen-carrito" class="border p-3"></div>

    <h5 class="mt-3 text-end">
      Total: $<span id="total">0</span>
    </h5>

  </div>

</div>

</section>

<div id="footer"></div>


<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>


<script>

const firebaseConfig = {
  apiKey: "AIzaSyCU79ZWBAHThRPVp44voMXIC42zq6abS4Y",
  authDomain: "muebles-ecommerce-d8fc0.firebaseapp.com",
  projectId: "muebles-ecommerce-d8fc0",
  storageBucket: "muebles-ecommerce-d8fc0.firebasestorage.app",
  messagingSenderId: "724872861374",
  appId: "1:724872861374:web:d94cbd14d1b790d391b0ef"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

</script>


<script>

// CARRITO

let carrito = JSON.parse(localStorage.getItem("carrito")) || [];

const resumen = document.getElementById("resumen-carrito");
const totalSpan = document.getElementById("total");


// MOSTRAR RESUMEN

function renderResumen(){

let total = 0;

resumen.innerHTML = "";

if(carrito.length === 0){

resumen.innerHTML = "<p>No hay productos en el carrito.</p>";

return;

}

carrito.forEach(prod=>{

const subtotal = prod.precio * prod.cantidad;

total += subtotal;

resumen.innerHTML += `

<div class="d-flex justify-content-between border-bottom py-2">

<div>
<strong>${prod.nombre}</strong><br>
Cantidad: ${prod.cantidad}
</div>

<div>
$${subtotal.toLocaleString()}
</div>

</div>

`;

});

totalSpan.textContent = total.toLocaleString();

}

renderResumen();


// FINALIZAR COMPRA

document.getElementById("form-checkout").addEventListener("submit", async function(e){

e.preventDefault();

const user = auth.currentUser;


// verificar login

if(!user){

alert("Debes iniciar sesiÃ³n");

window.location.href="login.html";

return;

}


// verificar carrito

if(carrito.length === 0){

alert("El carrito estÃ¡ vacÃ­o");

return;

}


// calcular total

let total = 0;

carrito.forEach(p=>{

total += p.precio * p.cantidad;

});


// crear pedido

const pedido = {

userId: user.uid,

emailUsuario: user.email,

cliente: {

nombre: document.getElementById("nombre").value,

direccion: document.getElementById("direccion").value,

localidad: document.getElementById("localidad").value,

telefono: document.getElementById("telefono").value,

email: document.getElementById("email").value

},

productos: carrito,

total: total,

fecha: new Date()

};


// guardar en firestore

try{

await db.collection("pedidos").add(pedido);

alert("Pedido confirmado correctamente ðŸŽ‰");

localStorage.removeItem("carrito");

window.location.href = "index.html";

}catch(error){

alert("Error al guardar pedido: " + error.message);

}

});

</script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script src="js/firebase.js"></script>


<script src="./js/navbar.js"></script>
<script src="./js/footer.js"></script>
<script src="./js/app.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>


</body>
</html>
