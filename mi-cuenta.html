<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mi cuenta | Glattam Amoblamientos</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<link rel="stylesheet" href="css/styles.css">

<style>

body{
background:#f8f9fa;
}

.card-cuenta{
border:none;
border-radius:14px;
box-shadow:0 6px 20px rgba(0,0,0,0.08);
}

.avatar{
width:80px;
height:80px;
border-radius:50%;
background:#212529;
color:white;
display:flex;
align-items:center;
justify-content:center;
font-size:32px;
font-weight:bold;
}

.info-item{
padding:10px 0;
border-bottom:1px solid #eee;
}

.info-item:last-child{
border-bottom:none;
}

.label{
font-size:13px;
color:#6c757d;
}

.valor{
font-weight:500;
font-size:15px;
}

</style>

</head>
<body>

<div id="navbar-container"></div>

<main class="container py-5">

<div class="row justify-content-center">

<div class="col-lg-6 col-md-8">

<div class="card card-cuenta p-4">

<div class="d-flex align-items-center gap-3 mb-4">

<div class="avatar" id="avatarInicial">
<i class="bi bi-person"></i>
</div>

<div>
<h4 id="nombreUsuario" class="mb-0">Cargando...</h4>
<div id="emailUsuario" class="text-muted"></div>
</div>

</div>

<hr>

<div class="info-item">
<div class="label">
<i class="bi bi-envelope"></i> Email
</div>
<div id="emailInfo" class="valor"></div>
</div>

<div class="info-item">
<div class="label">
<i class="bi bi-telephone"></i> Teléfono
</div>
<div id="telefonoUsuario" class="valor"></div>
</div>

<div class="info-item">
<div class="label">
<i class="bi bi-geo-alt"></i> Localidad
</div>
<div id="localidadUsuario" class="valor"></div>
</div>

<div class="info-item">
<div class="label">
<i class="bi bi-house"></i> Domicilio
</div>
<div id="domicilioUsuario" class="valor"></div>
</div>

<hr class="my-4">

<h4 class="mb-3">
<i class="bi bi-bag"></i>
Mis pedidos
</h4>

<div id="contenedorPedidos">

<div class="text-muted">
Cargando pedidos...
</div>

</div>

<hr>

<div class="d-grid gap-2 mt-3">

<a href="tienda.html" class="btn btn-outline-secondary">
<i class="bi bi-arrow-left"></i>
Volver a la tienda
</a>

<button onclick="logout()" class="btn btn-dark">
<i class="bi bi-box-arrow-right"></i>
Cerrar sesión
</button>

</div>

</div>

</div>

</div>

</main>

<div id="footer"></div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script src="js/firebase.js"></script>
<script src="js/navbar.js"></script>
<script src="js/footer.js"></script>

<script>

auth.onAuthStateChanged(async user => {

if(!user){

window.location.href="login.html";
return;

}

try{

/* =========================
   DATOS DEL USUARIO
========================= */

const doc = await db
.collection("usuarios")
.doc(user.uid)
.get();

if(doc.exists){

const data = doc.data();

const nombreCompleto =
(data.nombre || "") + " " + (data.apellido || "");

document.getElementById("nombreUsuario").innerText =
nombreCompleto;

document.getElementById("emailUsuario").innerText =
data.email || user.email;

document.getElementById("emailInfo").innerText =
data.email || user.email;

document.getElementById("telefonoUsuario").innerText =
data.telefono || "-";

document.getElementById("localidadUsuario").innerText =
data.localidad || "-";

document.getElementById("domicilioUsuario").innerText =
data.domicilio || "-";

/* Avatar inicial */
if(data.nombre){

document.getElementById("avatarInicial").innerText =
data.nombre.charAt(0).toUpperCase();

}

}
else{

document.getElementById("nombreUsuario").innerText =
"Usuario";

document.getElementById("emailUsuario").innerText =
user.email;

document.getElementById("emailInfo").innerText =
user.email;

}

/* =========================
   CARGAR PEDIDOS
========================= */

cargarPedidos(user.uid);

}
catch(error){

console.error(error);

}

});



/* =========================
   FUNCION CARGAR PEDIDOS
========================= */

async function cargarPedidos(uid){

const contenedor =
document.getElementById("contenedorPedidos");

contenedor.innerHTML = `
<div class="text-muted">
Cargando pedidos...
</div>
`;

try{

const snapshot = await db
.collection("pedidos")
.where("uid","==",uid)
.get();


if(snapshot.empty){

contenedor.innerHTML = `
<div class="text-muted">
No tenés pedidos todavía.
</div>
`;

return;

}


let html="";

snapshot.forEach(doc=>{

const orden = doc.data();

const fecha = orden.fecha
? new Date(orden.fecha.seconds * 1000)
.toLocaleDateString("es-AR")
: "-";

html += `

<div class="card mb-3">

<div class="card-body">

<div class="d-flex justify-content-between">
<strong>Pedido #${doc.id}</strong>
<strong>$${orden.total || 0}</strong>
</div>

<div class="text-muted small">
${fecha}
</div>

</div>

</div>

`;

});

contenedor.innerHTML = html;

}
catch(error){

console.error("ERROR REAL:", error);

contenedor.innerHTML = `
<div class="text-muted">
No tenés pedidos todavía.
</div>
`;

}

}


/* =========================
   LOGOUT
========================= */

function logout(){

auth.signOut().then(()=>{

window.location.href="index.html";

});

}

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>