<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mis pedidos | Glattam Amoblamientos</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>

html, body{
height:100%;
}

body{
display:flex;
flex-direction:column;
min-height:100vh;
background:#f8f9fa;
}

main{
flex:1;
}

/* Card pedido */
.card-pedido{
border-radius:12px;
box-shadow:0 4px 12px rgba(0,0,0,0.08);
border:none;
margin-bottom:20px;
transition:0.3s;
}

.card-pedido:hover{
transform:translateY(-3px);
box-shadow:0 8px 20px rgba(0,0,0,0.12);
}

/* Producto */
.producto-item{
border-bottom:1px solid #eee;
padding:8px 0;
}

.producto-item:last-child{
border-bottom:none;
}

</style>

</head>

<body>

<!-- NAVBAR -->
<div id="navbar-container"></div>

<!-- CONTENIDO -->
<main>

<div class="container my-5">

<h2 class="mb-4">
<i class="bi bi-bag"></i>
Mis pedidos
</h2>

<div id="lista-pedidos"></div>

</div>

</main>

<!-- FOOTER -->
<div id="footer"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Tu config -->
<script src="js/firebase.js"></script>

<!-- Navbar y Footer -->
<script src="js/navbar.js"></script>
<script src="js/footer.js"></script>

<script>

const contenedor = document.getElementById("lista-pedidos");


// Spinner inicial
contenedor.innerHTML = `
<div class="text-center py-5">

<div class="spinner-border text-dark mb-3"></div>

<div class="text-muted">
Cargando tus pedidos...
</div>

</div>
`;


// Verificar usuario
auth.onAuthStateChanged(async user => {

if(!user){

window.location.href="login.html";
return;

}

try{

const snapshot = await db
.collection("pedidos")
.where("userId","==",user.uid)
.orderBy("fecha","desc")
.get();


// SIN PEDIDOS
if(snapshot.empty){

contenedor.innerHTML = `
<div class="card border-0 shadow-sm text-center py-5">

<div class="card-body">

<i class="bi bi-bag-x fs-1 text-muted"></i>

<h5 class="mt-3">
Todavía no tenés pedidos
</h5>

<p class="text-muted">
Cuando realices una compra aparecerá aquí
</p>

<a href="tienda.html" class="btn btn-dark mt-2">
Ir a la tienda
</a>

</div>

</div>
`;

return;

}


// MOSTRAR PEDIDOS
contenedor.innerHTML = "";

snapshot.forEach(doc => {

const pedido = doc.data();

let productosHTML = "";

pedido.productos.forEach(p=>{

productosHTML += `
<div class="producto-item">

<strong>${p.nombre}</strong>

<div class="text-muted small">
Cantidad: ${p.cantidad}
${p.medida ? " | Medida: "+p.medida : ""}
${p.color ? " | Color: "+p.color : ""}
</div>

</div>
`;

});

contenedor.innerHTML += `

<div class="card card-pedido p-4">

<div class="d-flex justify-content-between align-items-center mb-2">

<div>

<span class="badge bg-dark">
Pedido
</span>

<span class="text-muted small ms-2">
${doc.id}
</span>

</div>

<div class="fw-bold fs-5">
$${pedido.total.toLocaleString()}
</div>

</div>

<div class="text-muted small mb-3">

<i class="bi bi-calendar"></i>

${pedido.fecha.seconds 
? new Date(pedido.fecha.seconds * 1000).toLocaleString()
: new Date(pedido.fecha).toLocaleString()
}

</div>

${productosHTML}

</div>

`;

});

}catch(error){

contenedor.innerHTML = `

<div class="card border-0 shadow-sm text-center py-5">

<i class="bi bi-exclamation-triangle fs-1 text-danger"></i>

<h5 class="mt-3">
Error al cargar pedidos
</h5>

<p class="text-muted">
Intentá nuevamente
</p>

<button onclick="location.reload()" class="btn btn-dark">
Reintentar
</button>

</div>
`;

console.error(error);

}

});

</script>

</body>
</html>
